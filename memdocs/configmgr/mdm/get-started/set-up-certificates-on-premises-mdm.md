---
title: 本地 MDM 的证书
titleSuffix: Configuration Manager
description: 在 Configuration Manager 中，为与本地移动设备管理（MDM）的受信任通信设置证书。
ms.date: 01/09/2020
ms.prod: configuration-manager
ms.technology: configmgr-mdm
ms.topic: conceptual
ms.assetid: 2a7d7170-1933-40e9-96d6-74a6eb7278e2
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: bc63a21970bb522407c86d027690b83894b3cb99
ms.sourcegitcommit: 578ad1e8088f7065b565e8a4f4619f5a26b94001
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/21/2020
ms.locfileid: "81724661"
---
# <a name="set-up-certificates-for-trusted-communications-with-on-premises-mdm"></a>为与本地 MDM 的受信任通信设置证书

适用范围：  Configuration Manager (Current Branch)

Configuration Manager 本地移动设备管理（MDM）要求你为与托管设备的受信任通信配置站点系统角色。 需要两种类型的证书：

- 承载所需站点系统角色的服务器上的 IIS 中的**web 服务器证书**。 如果一台服务器托管多个站点系统角色，则只需要该服务器的一个证书。 如果每个角色都在单独的服务器上，则每个服务器都需要一个单独的证书。

- 颁发 web 服务器证书的证书颁发机构（CA）的**受信任的根证书**。 在需要连接到站点系统角色的所有设备上安装此根证书。

对于已加入域的设备，如果使用 Active Directory 证书服务，则它可以在所有设备上自动安装这些证书。 对于未加入域的设备，请通过其他方式安装受信任的根证书。

对于批量注册的设备，可以在注册包中包含证书。 对于用户注册的设备，则需要通过电子邮件，Web 下载或某些其他方法来添加证书。

如果使用大众公共 CA （如 Verisign 或 GoDaddy）颁发服务器证书，则可以避免在每个设备上手动安装受信任的根证书。 大多数设备本机信任这些公共机构。 此方法对于用户注册的设备是一种有用的替代方法，而不是通过其他方式安装证书。

> [!IMPORTANT]  
> 有多种方法可为本地 MDM 的设备和站点系统服务器之间的受信任通信设置证书。 本文中的信息是执行此操作的一种方法的示例。 此方法需要 Active Directory 证书服务，具有证书颁发机构和证书颁发机构 web 注册角色。 有关详细信息，请参阅[Active Directory 证书服务](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831740\(v=ws.11\))。

## <a name="publish-the-crl"></a><a name="bkmk_configCa"></a>发布 CRL

默认情况下，Active Directory 证书颁发机构（CA）使用基于 LDAP 的证书吊销列表（Crl）。 它允许连接到已加入域的设备的 CRL。 若要允许未加入域的设备信任 CA 颁发的证书，请添加基于 HTTP 的 CRL。

1. 在运行网站证书颁发机构的服务器上，依次单击 "**开始**" 菜单、"**管理工具**" 和 "**证书颁发机构**"。

1. 在证书颁发机构控制台中，右键单击**CertificateAuthority**，然后选择 "**属性**"。

1. 在 CertificateAuthority 属性中，切换到 "**扩展**" 选项卡。请确保 "**选择扩展**" 设置为 " **CRL 分发点（CDP）**"。

1. 选择 `http://<ServerDNSName>/CertEnroll/<CAName><CRLNameSuffix><DeltaCRLAllowed>.crl`。 然后选择以下选项：

    - **包括在 Crl 中。客户端使用它来查找增量 CRL 位置。**

    - **包含在已颁发证书的 CDP 扩展中。**

    - **包含在已颁发 Crl 的 IDP 扩展中**

1. 切换到 "**退出模块**" 选项卡。选择 "**属性**"，然后选择 **"允许将证书发布到文件系统"**。 你会看到一个重新启动 Active Directory 证书服务的通知。

1. 右键单击 "**吊销的证书**"，选择 "**所有任务**"，然后选择 "**发布**"。

1. 在 "发布 CRL" 窗口中，选择 "**仅增量 CRL**"，然后选择 **"确定"** 以关闭窗口。

## <a name="create-the-certificate-template"></a><a name="bkmk_certTempl"></a>创建证书模板

CA 使用 web 服务器证书模板为宿主站点系统角色的服务器颁发证书。 这些服务器将是站点系统角色和已注册设备之间受信任通信的 SSL 终结点。

1. 创建名为**CONFIGMGR MDM 服务器**的域安全组。 将站点系统服务器的计算机帐户添加到组中。

1. 在证书颁发机构控制台中，右键单击 "**证书模板**"，然后选择 "**管理**"。 此操作将加载证书模板控制台。

1. 在结果窗格中，右键单击在 "**模板显示名称**" 列中显示 " **Web 服务器**" 的条目，然后选择 "**复制模板**"。

1. 在 "**复制模板**" 窗口中，选择 " **Windows 2003 server enterprise Edition** " 或 " **windows 2008 server enterprise Edition**"，然后选择 **"确定"**。

    > [!TIP]
    > Configuration Manager 支持 Windows 2008 服务器证书模板，也称为 V3 或加密：下一代加密技术（CNG）证书。 有关详细信息，请参阅 [CNG 证书概述](../../core/plan-design/network/cng-certificates-overview.md)。

    如果 CA 在 Windows Server 2012 或更高版本上运行，则此窗口不会显示 "证书模板版本" 选项。 复制模板之后，在模板属性的 "**兼容性**" 选项卡上选择版本。

1. 在 "**新模板的属性**" 窗口的 "**常规**" 选项卡上，输入模板名称。 CA 使用此名称生成将在 Configuration Manager 站点系统上使用的 web 证书。 例如，键入 " **CONFIGMGR MDM web 服务器**"。

1. 切换到 "**使用者名称**" 选项卡，然后**从 Active Directory 信息中**选择 "生成"。 对于 "使用者名称" 格式，指定 " **DNS 名称**"。 如果选择了 "**用户主体名称（UPN）** "，则禁用备用使用者名称的选项。

1. 切换到 "**安全**" 选项卡。

    1. 从 "**域管理员**" 和 "**企业管理员**" 安全组中删除 "**注册**" 权限。

    1. 选择 "**添加**"，然后输入安全组的名称。 例如， **CONFIGMGR MDM 服务器**。 选择 **"确定"** 关闭窗口。

    1. 选择此组的 "**注册**" 权限。 请勿删除 "**读取**" 权限。

1. 选择 **"确定"** 保存更改，然后关闭 "证书模板" 控制台。

1. 在证书颁发机构控制台中，右键单击 "**证书模板**"，选择 "**新建**"，然后选择 "**要颁发的证书模板**"。

1. 在 "**启用证书模板**" 窗口中，选择新模板。 例如， **CONFIGMGR MDM web 服务器**。 然后选择 **"确定"** 保存并关闭窗口。

## <a name="request-the-certificate"></a><a name="bkmk_requestCert"></a>申请证书

此过程介绍如何请求 IIS 的 web 服务器证书。 为承载本地 MDM 角色之一的每个站点系统服务器执行此过程。

1. 在承载其中一个角色的站点系统服务器上，以管理员身份打开命令提示符。 输入`mmc`以打开一个空的 Microsoft 管理控制台。

1. 在控制台窗口中，打开 "**文件**" 菜单，然后选择 "**添加/删除管理单元**"。

    1. 从可用管理单元列表中选择 "**证书**"，然后选择 "**添加**"。

    1. 在 "证书管理单元" 窗口中，选择 "**计算机帐户**"。 选择 "**下一步**"，然后选择 "**完成**" 来管理本地计算机。

    1. 选择 **"确定"** 退出 "添加或删除管理单元" 窗口。

1. 展开 "**证书（本地计算机）**"，然后选择 "**个人**" 存储。 中转到 "**操作**" 菜单，选择 "**所有任务**"，然后选择 "**申请新证书**"。 此操作与 Active Directory 证书服务通信，以便使用之前创建的模板创建新证书。

    1. 在证书注册向导中的 "开始之前" 页上，选择 "**下一步**"。

    1. 在 "选择证书注册策略" 页上，选择 " **Active Directory 注册策略**"，然后选择 "**下一步**"。

    1. 选择 web 服务器证书模板（**CONFIGMGR MDM Web 服务器**），然后选择 "**注册**"。

    1. 请求证书后，选择 "**完成**"。

每个服务器都需要唯一的 web 服务器证书。 为承载所需站点系统角色之一的每个服务器重复此过程。 如果一个服务器托管了所有站点系统角色，则只需要请求一个 Web 服务器证书。

## <a name="bind-the-certificate"></a><a name="bkmk_bindCert"></a>绑定证书

下一步是将新证书绑定到 web 服务器。 对于托管*注册点*和*注册代理点*站点系统角色的每个服务器，请执行此过程。 如果一个服务器托管了所有站点系统角色，则只需执行此过程一次。

> [!NOTE]
> 对于分发点和设备管理点站点系统角色，无需执行此过程。 它们会在注册过程中自动接收所需的证书。

1. 在托管注册点或注册代理点的服务器上，请在 "**开始**" 菜单中选择 "**管理工具**"，然后选择 " **IIS 管理器**"。

1. 在连接列表中，选择 "**默认**网站"，然后选择 "**编辑绑定**"。

    1. 在 "站点绑定" 窗口中，选择 " **https**"，然后选择 "**编辑**"。

    1. 在 "编辑网站绑定" 窗口中，为**SSL 证书**选择新注册的证书。 选择 **"确定"** 保存，然后选择 "**关闭**"。

1. 在 IIS 管理器控制台的 "连接" 列表中，选择 "web 服务器"。 在右侧的操作面板中，选择 "**重新启动**"。 此操作将重启 web 服务器服务。

## <a name="export-the-trusted-root-certificate"></a><a name="bkmk_exportCert"></a>导出受信任的根证书

Active Directory 证书服务会自动在所有已加入域的设备上从 CA 安装所需的证书。 若要获取未加入域的设备与站点系统角色通信所需的证书，请从绑定到 web 服务器的证书中将其导出。

1. 在 IIS 管理器中，选择 "**默认**网站"。 在右侧的 "操作" 面板中，选择 "**绑定**"。

1. 在 "站点绑定" 窗口中，选择 " **https**"，然后选择 "**编辑**"。

1. 选择 web 服务器证书，然后选择 "**查看**"。

1. 在 "web 服务器证书" 的 "属性" 中，切换到 "**证书路径**" 选项卡。选择证书路径的根目录，然后选择 "**查看证书**"。

1. 在根证书的属性中，切换到 "**详细信息**" 选项卡，然后选择 "**复制到文件**"。

1. 在证书导出向导的 "欢迎" 页上，选择 "**下一步**"。

1. 选择 " **DER 编码的二进制 x.509 （。CER）** ，然后选择 "**下一步**"。

1. 输入路径和文件名以标识此受信任的根证书。 对于文件名，单击 "**浏览 ...**"，选择要保存证书文件的位置，为文件命名，然后选择 "**下一步**"。

1. 查看设置，然后选择 "**完成**" 将证书导出到文件。

根据你的证书颁发机构设计，你可能需要导出其他从属 CA 根证书。 重复此过程以导出 web 服务器证书的证书路径中的其他证书。

## <a name="next-step"></a>后续步骤

> [!div class="nextstepaction"]
> [设置设备注册](set-up-device-enrollment-on-premises-mdm.md)
