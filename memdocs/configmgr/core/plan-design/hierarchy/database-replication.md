---
title: 数据库复制
titleSuffix: Configuration Manager
description: 了解 Configuration Manager 数据库复制如何使用 SQL Server 在层次结构中传输数据。
ms.date: 08/09/2019
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: conceptual
ms.assetid: 8b495b02-c966-4eb3-92b9-52ebbf5c38ae
author: mestew
ms.author: mstewart
manager: dougeby
ms.openlocfilehash: d1a2c8baa349e6499aa483f947d94f7459357be4
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/21/2020
ms.locfileid: "81703595"
---
# <a name="database-replication"></a>数据库复制

适用范围：  Configuration Manager (Current Branch)

Configuration Manager 数据库复制使用 SQL Server 来传输数据。 它使用此方法将其站点数据库中的更改与层次结构中其他站点上的数据库中的信息进行合并。

请注意有关数据库复制的以下几点：

- 所有站点共享相同的信息。  

- 在层次结构中安装站点时，Configuration Manager 将自动在新站点与其父站点之间建立数据库复制。  

- 当站点安装完成后，数据库复制将自动开始。  

向层次结构添加新站点时，Configuration Manager 会在该新站点创建通用数据库。 父站点在其数据库中创建相关数据的快照。 然后，使用[基于文件的复制](file-based-replication.md)将快照传输到新站点。 然后，新站点使用 SQL Server 成批复制程序 (BCP) 将信息加载到其 Configuration Manager 数据库的本地副本。 在快照加载后，每个站点均会与其他站点执行数据库复制。  

为在站点之间复制数据，Configuration Manager 会使用其自己的数据库复制服务。 数据库复制服务使用 SQL Server 更改跟踪来监视本地站点数据库的变化。 然后，它使用 SQL Server Service Broker (SSB) 将更改复制到其他站点。 默认情况下，此过程使用 TCP 端口 4022。  


## <a name="replication-groups"></a>复制组

Configuration Manager 将由数据库复制造成的重复数据划分到不同复制组。 每个复制组都有一个单独的固定复制计划。 站点使用此计划来确定将更改复制到其他站点的频率。  

例如，对基于角色的管理配置的更改会快速复制到其他站点。 此行为可确保其他站点可以快速地强制执行这些更改。 优先级较低的配置更改（如请求安装新辅助站点），复制的紧迫性会少些。 新站点请求可能需要几分钟才能达到目标主站点。  


## <a name="settings"></a>设置

对于数据库复制，可以修改以下设置：  

- **数据库复制链接**：控制特定流量何时遍历网络。  

- **分布式视图**：在管理中心站点 (CAS) 针对选定站点数据发出请求时，它可以从子主站点的数据库中直接访问该数据。  

- **计划**：指定使用复制链接的情形并指定复制不同类型的站点数据的情形。  

- **摘要**：针对遍历复制链接的网络流量更改数据摘要设置。 默认情况下，汇总每 15 分钟发生一次。 它用于数据库复制报表。  

- **数据库复制阈值**：定义站点何时将链接报告为降级或失败。 还可以配置 Configuration Manager 在何时发出有关复制链接处于降级或失败状态的警报。  


## <a name="types-of-data"></a>数据类型

Configuration Manager 将它复制的数据主要分为全局数据和站点数据两类   。 当发生数据库复制时，站点将跨数据库复制链接来传输全局数据和站点数据的更改。 全局数据复制到父站点或子站点。 站点数据仅复制到父站点。 第三类数据类型（本地数据）  不会复制到其他任何站点。 本地数据是指其他站点不需要的信息。  

### <a name="global-data"></a>全局数据

全局数据是管理员创建的对象，这些对象将复制到整个层次结构中的所有站点。 辅助站点仅接收作为全局代理数据的全局数据的一个子集。 用户在 CAS 和主站点创建全局数据。 此类型包括以下数据：

- 软件部署
- 软件更新
- 集合定义
- 基于角色的管理安全作用域

### <a name="site-data"></a>站点数据

站点数据是 Configuration Manager 主站点及其分配的客户端创建的操作信息。 站点数据复制到 CAS，但不复制到其他主站点。 站点数据仅在 CAS 和数据源自的主站点中可见。 只能修改在创建站点数据的主站点上的站点数据。 此类型包括以下数据：

- 硬件清单
- 状态消息
- 警报
- 基于查询的集合的结果

所有站点数据都复制到 CAS。 CAS 为整个站点层次结构执行管理和报告操作。  


## <a name="database-replication-links"></a><a name="bkmk_Dblinks"></a> 数据库复制链接

在层次结构中安装新站点时，Configuration Manager 将自动在父站点和新站点之间创建数据库复制链接。 它创建单个链接来连接两个站点。  

若要控制跨复制链接的数据传输，请更改每个链接的设置。 每个复制链接均支持单独的配置。 每个数据库复制链接都包括以下控件：  

- 停止将所选站点数据从主站点复制到 CAS。 此操作可使 CAS 从主站点的数据库中直接访问此数据。  

- 计划将选定站点数据从子主站点传输到 CAS。

- 定义用于确定数据库复制链接处于降级状态或失败状态的设置。

- 指定何时针对失败的复制链接发出警报。

- 指定 Configuration Manager 对使用复制链接的复制流量的相关数据进行汇总的频率。 它在报表中使用此数据。

若要配置数据库复制链接，请在 Configuration Manager 控制台中，转到“监视”  工作区。 选择“数据库复制”  节点，然后编辑该链接的属性。 此节点也位于“层次结构配置”节点下的“管理”工作区中   。 可以从复制链接的父站点或子站点中编辑复制链接。  

> [!TIP]  
> 你可以编辑任一工作区内“数据库复制”  节点中的数据库复制链接。 不过，在使用“监视”  工作区中的“数据复制”  节点时，还可以查看数据库复制的状态。 它还提供对[复制链接分析器](../../servers/manage/monitor-replication.md#BKMK_RLA)工具的访问。 使用此工具可帮助调查数据库复制的问题。  

有关如何配置复制链接的详细信息，请参阅[站点数据库复制控件](#BKMK_DBRepControls)。 有关如何监视复制的详细信息，请参阅[监视数据库复制](../../servers/manage/monitor-replication.md)。  


## <a name="distributed-views"></a><a name="bkmk_distviews"></a> 分布式视图  

通过分布式视图，当你在 CAS 上针对所选站点数据发出请求时，它会直接访问子主站点上的数据库。 此直接访问无需再从主站点将该站点数据复制到 CAS。 由于每个复制链接均与其他复制链接无关，因此可在所选的复制链接上启用分布式视图。 不能在主站点和辅助站点之间使用分布式视图。  

分布式视图提供以下好处：  

- 降低 CPU 负载以在 CAS 和主站点上处理数据库更改

- 降低跨网络传输到 CAS 的数据量

- 改善托管 CAS 数据库的 SQL Server 的性能

- 减少 CAS 数据库使用的磁盘空间

当主站点在网络上临近 CAS 且两个站点始终启动并始终相连时，考虑使用分布式视图。 分布式视图会将站点间选定数据的复制替换为每个站点上 SQL Server 之间的直接连接。 每次请求此数据时，CAS 都会建立直接连接。

在以下示例场景中，站点请求分布式视图数据：

- 运行报表或查询时
- 在资源浏览器中查看信息时
- 对包含基于站点数据的规则的集合进行集合评估时

默认情况下，每个复制链接均已关闭分布式视图。 启用分布式视图时，选择不会跨该链接复制到 CAS 的站点数据。 CAS 会从共享该链接的子主站点数据库直接访问此数据。 你可以为分布式视图配置以下类型的站点数据：  

- 来自客户端的硬件清单数据 
- 来自客户端的软件清单和软件计数数据 
- 来自客户端、主站点和所有辅助站点的状态消息 

在 Configuration Manager 控制台或报表中查看数据时，从操作方面来说，分布式视图对于你不可见。 当你请求针对分布式视图启用的数据时，CAS 站点数据库服务器会直接访问子主站点的数据库以检索信息。

例如，使用连接到 CAS 的 Configuration Manager 控制台。 从两个主站点请求有关硬件清单的信息：ABC 和 XYZ。 仅为站点 ABC 上的分布式视图启用硬件清单。 CAS 从其自己的数据库中检索 XYZ 客户端的清单信息。 CAS 直接从站点 ABC 的数据库中检索 ABC 客户端的清单信息。 此信息将出现在 Configuration Manager 控制台或报表中，但不标识信息源。  

如果复制链接具有一类已对分布式视图启用的数据，子主站点就不会将该数据复制到 CAS。 关闭某类数据的分布式视图后，子主站点会恢复到 CAS 的正常数据复制。 必须先在主站点和 CAS 之间将包含此数据的复制组重新初始化，CAS 上才会提供此数据。 卸载已启用分布式视图的主站点后，CAS 必须先完成其数据的重新初始化，然后才能在 CAS 上访问已对分布式视图启用的数据。  

> [!IMPORTANT]  
> 在站点层次结构中的任何复制链接上使用分布式视图时，在卸载任何主站点之前，先关闭所有复制链接的分布式视图。 有关详细信息，请参阅[卸载使用分布式视图的主站点](../../servers/deploy/install/uninstall-sites-and-hierarchies.md#bkmk_distviews)。  

### <a name="prerequisites-and-limitations-for-distributed-views"></a>分布式视图的先决条件和限制  

- 只能在 CAS 和主站点之间的复制链接上使用分布式视图。

- CAS 必须使用 SQL Server 企业版。 主站点没有此要求。

- CAS 只能拥有 SMS 提供程序的一个实例。 在站点数据库服务器上安装单个实例。 此配置支持 Kerberos 身份验证。 CAS 上的 SQL Server 要求使用 Kerberos 访问子主站点的 SQL Server。 对于子主站点上的 SMS 提供程序没有任何限制。

- 只能在 CAS 上安装一个 Reporting Services 点。 在站点数据库服务器上安装 SQL Server Reporting Services。 此配置支持 Kerberos 身份验证。 CAS 上的 SQL Server 要求使用 Kerberos 访问子主站点的 SQL Server。

- 无法在 [SQL Server 群集](../../servers/deploy/configure/use-a-sql-server-cluster-for-the-site-database.md)上托管站点数据库。

- 在版本 1902 及更早版本中，无法在 [SQL Server Always On 可用性组](../../servers/deploy/configure/sql-server-alwayson-for-a-highly-available-site-database.md)上托管站点数据库。 若要支持此配置，请更新到版本 1906 或更高版本。<!-- SCCMDocs-pr#3792 -->

- CAS 数据库服务器的计算机帐户需要对主站点数据库具有读取权限  。

> [!IMPORTANT]  
> 对于数据库复制链接而言，分布式视图和数据复制[时间计划](#BKMK_schedules)是相互排斥的设置。  


## <a name="schedule-transfers-of-site-data"></a><a name="BKMK_schedules"></a> 计划站点数据的传输

为了帮助你控制将站点数据从子主站点复制到 CAS 时所用的网络带宽，请计划使用复制链接的时间。 然后，指定复制不同类型的站点数据的时间。 你可以控制主站点复制状态消息、清单和计数数据的时间。 辅助站点中的数据库复制链接不支持站点数据计划。 无法计划全局数据传输。  

配置数据库复制链接计划时，可以限制所选站点数据从主站点到 CAS 的传输。 还可以配置不同的时间来复制不同类型的站点数据。  

> [!IMPORTANT]  
> 对于数据库复制链接而言，[分布式视图](#bkmk_distviews)和数据复制时间计划是相互排斥的配置。  


## <a name="summarization-of-traffic"></a><a name="BKMK_SummarizeDBReplication"></a> 流量摘要  

每个站点会定期汇总关于遍历站点数据库复制链接的网络流量的数据。 站点将汇总数据用于数据库复制报表。 复制链接上的两个站点都汇总遍历复制链接的网络流量 站点数据库服务器汇总数据。 汇总数据后，此信息会作为全局数据复制到其他站点。  

默认情况下，汇总每 15 分钟发生一次。 若要修改网络流量汇总的频率，可在数据库复制链接属性中编辑“摘要间隔”  。 汇总频率会影响你在报表中查看的关于数据库复制的信息。 可以选择 5 到 60 分钟的间隔。 如果增加汇总频率，则会增加复制链接上每个站点中 SQL Server 的处理负荷。  

## <a name="database-replication-thresholds"></a><a name="BKMK_DBRepThresholds"></a>数据库复制阈值

数据库复制阈值定义 Configuration Manager 将数据库复制链接状态报告为降级或失败的时间。 默认情况下，如果任何一个复制组在 12 次连续尝试后无法完成复制，则将链接设置为降级  。 如果任何一个复制组在 24 次连续尝试期间无法完成复制，则将链接设置为失败  。  

可以为降级或失败状态指定自定义值。 如果调整这些值，可以更准确地监视跨链接进行的数据库复制的运行状况。  

一个或多个复制组可能无法复制，而其他复制组可以继续成功复制。 计划在首次报告降级时查看链接的复制状态。

在以下情况下，请考虑修改链接的降级或失败状态的重试值：

- 特定复制组存在重复延迟，其延迟不是问题

- 站点之间的网络链接具有低可用带宽

如果站点将链接设置为降级或失败之前增加重试次数，则可以消除已知问题的假警告。 此操作可让用户更加准确地跟踪链接的状态。  

若要了解该组复制发生的频率，请考虑每个复制组的复制同步间隔。 若要查看复制组的同步间隔  ，请转到 Configuration Manager 控制台的“监视”  工作区。 在“数据库复制”  节点中，选择复制链接的“复制详细信息”  选项卡。  

有关如何监视数据库复制（包括如何查看复制状态）的详细信息，请参阅[监视数据库复制](../../servers/manage/monitor-replication.md)。  


## <a name="site-database-replication-controls"></a><a name="BKMK_DBRepControls"></a> 站点数据库复制控件  

可更改每个站点数据库的设置，帮助你控制用于数据库复制的网络带宽。 这些设置仅适用于在其中配置设置的站点数据库。 站点通过数据库将任何数据复制到任何其他站点时，会始终使用这些设置。  

可以为每个站点数据库修改以下复制控件：  

- SSB 端口  

- 在复制失败触发站点重新初始化其站点数据库副本之前等待的时间段  

- 压缩站点复制的数据。 只会为站点之间的传输压缩数据，而不会为任一站点上站点数据库中的存储压缩数据。  

若要更改站点数据库复制控件的设置，请在 Configuration Manager 控制台中的“数据库复制”  节点上，编辑该站点数据库的属性。 此节点出现在“管理”  工作区中的“层次结构配置”  节点下面，也出现在“监视工作区”  中。 若要编辑站点数据库的属性，请选择站点之间的复制链接，然后打开“父数据库属性”  或“子数据库属性”  。  

> [!TIP]  
> 你可以配置任一工作区内“数据库复制”  节点中的数据库复制控件。 但是，如果使用“监视”  工作区内的“数据库复制”  节点，则也可以查看复制链接的数据库复制状态，并且可以访问复制链接分析器工具以帮助你调查复制问题。  


## <a name="see-also"></a>另请参阅

[监视复制](../../servers/manage/monitor-replication.md)

[SQL 复制故障排除](../../servers/manage/replication/overview.md)
